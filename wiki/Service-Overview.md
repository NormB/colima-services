# Service Overview

Complete reference for all services in the DevStack Core infrastructure.

## Table of Contents

- [Infrastructure Services](#infrastructure-services)
  - [HashiCorp Vault](#hashicorp-vault)
  - [PostgreSQL](#postgresql)
  - [PgBouncer](#pgbouncer)
  - [MySQL](#mysql)
  - [Redis Cluster](#redis-cluster)
  - [RabbitMQ](#rabbitmq)
  - [MongoDB](#mongodb)
  - [Forgejo (Git Server)](#forgejo-git-server)
- [Observability Stack](#observability-stack)
  - [Prometheus](#prometheus)
  - [Grafana](#grafana)
  - [Loki](#loki)
  - [Vector](#vector)
  - [cAdvisor](#cadvisor)
- [Reference Applications](#reference-applications)
  - [FastAPI Code-First](#fastapi-code-first)
  - [FastAPI API-First](#fastapi-api-first)
  - [Go/Gin API](#gogin-api)
  - [Node.js/Express API](#nodejsexpress-api)
  - [Rust/Actix-web API](#rustactix-web-api)
  - [TypeScript API-First](#typescript-api-first)

---

## Infrastructure Services

### HashiCorp Vault

**Purpose:** Centralized secrets management and PKI (Public Key Infrastructure).

**Key Features:**
- ðŸ” Stores all service credentials (passwords, API keys)
- ðŸ”‘ Two-tier PKI (Root CA â†’ Intermediate CA â†’ Service Certificates)
- ðŸ”“ Auto-unseals on startup (no manual intervention)
- ðŸŒ Web UI at http://localhost:8200/ui
- ðŸ“ Audit logging for all secret access

**Configuration:**
- **Image:** `hashicorp/vault:latest`
- **Port:** 8200 (HTTP API + UI)
- **Static IP:** 172.20.0.21
- **Storage:** File backend (persistent across restarts)
- **Seal Type:** Shamir (3 of 5 keys required)

**Critical Files:**
```bash
~/.config/vault/keys.json       # 5 unseal keys (BACKUP!)
~/.config/vault/root-token      # Root token for admin access
~/.config/vault/ca/             # CA certificates
~/.config/vault/certs/          # Service certificates
```

**Common Operations:**
```bash
# Check Vault status
./manage-devstack.sh vault-status

# View root token
./manage-devstack.sh vault-token

# Get service password
./manage-devstack.sh vault-show-password postgres

# Access UI
open http://localhost:8200/ui
# Token: cat ~/.config/vault/root-token
```

**First-Time Setup:**
```bash
# 1. Start services
./manage-devstack.sh start

# 2. Initialize Vault (auto-creates keys + token)
./manage-devstack.sh vault-init

# 3. Bootstrap PKI + store all credentials
./manage-devstack.sh vault-bootstrap
```

âš ï¸ **CRITICAL:** Backup `~/.config/vault/` immediately! Data cannot be recovered without these files.

---

### PostgreSQL

**Purpose:** Primary relational database for Forgejo (Git server) and local development.

**Configuration:**
- **Image:** `postgres:16-alpine` (ARM64 native)
- **Port:** 5432
- **Static IP:** 172.20.0.10
- **Credentials:** Auto-fetched from Vault at `secret/postgres`
- **Storage:** Docker volume (`postgres_data`)
- **Encoding:** UTF8, Locale: C
- **Max Connections:** 100

**Performance Tuning:**
```yaml
shared_buffers: 256MB
effective_cache_size: 1GB
work_mem: 8MB
```

**Connection Examples:**
```bash
# From macOS (host)
psql -h localhost -p 5432 -U dev_admin -d dev_database

# Get password first
./manage-devstack.sh vault-show-password postgres

# From Docker network
psql -h postgres -p 5432 -U dev_admin -d dev_database

# Using management script
./manage-devstack.sh shell postgres
```

**Health Check:**
```bash
# Automatic (every 60s)
pg_isready -U dev_admin

# Manual
docker exec dev-postgres pg_isready -U dev_admin
```

**Optional TLS:**
- Enable: Set `POSTGRES_ENABLE_TLS=true` in `.env`
- Certificates: Auto-generated by Vault PKI
- Dual-mode: Accepts both TLS and non-TLS connections

---

### PgBouncer

**Purpose:** Connection pooling for PostgreSQL (reduces connection overhead).

**Configuration:**
- **Image:** `edoburu/pgbouncer:latest`
- **Port:** 6432
- **Static IP:** 172.20.0.11
- **Pool Mode:** Transaction (best for web apps)
- **Max Connections:** 100
- **Default Pool Size:** 10

**When to Use:**
- âœ… Web applications (connection-per-request)
- âœ… APIs with high request frequency
- âœ… Microservices connecting to shared database
- âŒ Long-lived connections (use direct PostgreSQL)
- âŒ Admin tasks (use direct PostgreSQL)

**Connection:**
```bash
# Through PgBouncer (port 6432)
psql -h localhost -p 6432 -U dev_admin -d dev_database

# Direct PostgreSQL (port 5432) - for comparison
psql -h localhost -p 5432 -U dev_admin -d dev_database
```

**Comparison:**
| Feature | Direct (5432) | PgBouncer (6432) |
|---------|---------------|------------------|
| Use Case | Admin, long connections | APIs, web apps |
| Overhead | Higher | Lower |
| Connection Limit | 100 (PostgreSQL) | 100 clients â†’ 10 pool |
| Session Variables | Full support | Limited support |

---

### MySQL

**Purpose:** Legacy database support during migration period.

**Configuration:**
- **Image:** `mysql:8.0`
- **Port:** 3306
- **Static IP:** 172.20.0.12
- **Credentials:** Auto-fetched from Vault at `secret/mysql`
- **Character Set:** utf8mb4
- **Collation:** utf8mb4_unicode_ci
- **Max Connections:** 100
- **InnoDB Buffer Pool:** 256MB

**Connection:**
```bash
# Interactive (prompts for password)
mysql -h 127.0.0.1 -u dev_admin -p

# Non-interactive (use carefully)
mysql -h 127.0.0.1 -u dev_admin -p$(./manage-devstack.sh vault-show-password mysql) dev_database

# From container
docker exec -it dev-mysql mysql -u dev_admin -p
```

**Health Check:**
```bash
mysqladmin -u dev_admin -p$(cat ~/.config/vault/password) ping
```

**Optional TLS:**
- Enable: Set `MYSQL_ENABLE_TLS=true` in `.env`
- Certificates: Auto-generated by Vault PKI

---

### Redis Cluster

**Purpose:** Distributed caching with high availability and horizontal scaling.

**Architecture:**
- **3 Master Nodes** (no replicas in dev mode)
  - Node 1 (172.20.0.13): Slots 0-5460
  - Node 2 (172.20.0.16): Slots 5461-10922
  - Node 3 (172.20.0.17): Slots 10923-16383
- **Total Hash Slots:** 16,384 (distributed across nodes)
- **Memory per Node:** 256MB (768MB total)
- **Eviction Policy:** allkeys-lru

**Configuration:**
- **Image:** `redis:7-alpine`
- **Ports:**
  - 6379, 6380, 6381 (data ports)
  - 16379, 16380, 16381 (cluster bus - internal)
- **Credentials:** Shared password from Vault at `secret/redis-1`
- **Persistence:** AOF (Append-Only File) + RDB snapshots

**Connection:**
```bash
# ALWAYS use -c flag for cluster mode!
redis-cli -c -a $(./manage-devstack.sh vault-show-password redis-1) -p 6379

# Connect to specific nodes
redis-cli -c -a $REDIS_PASSWORD -p 6380  # Node 2
redis-cli -c -a $REDIS_PASSWORD -p 6381  # Node 3
```

**First-Time Initialization:**
```bash
# After starting containers for the first time
./configs/redis/scripts/redis-cluster-init.sh

# Verify cluster is healthy
docker exec dev-redis-1 redis-cli -a $REDIS_PASSWORD cluster info
```

**Cluster Operations:**
```bash
# Check cluster status
docker exec dev-redis-1 redis-cli -a $REDIS_PASSWORD cluster info

# List all nodes and their roles
docker exec dev-redis-1 redis-cli -a $REDIS_PASSWORD cluster nodes

# View slot distribution
docker exec dev-redis-1 redis-cli -a $REDIS_PASSWORD cluster slots

# Comprehensive health check
docker exec dev-redis-1 redis-cli --cluster check 172.20.0.13:6379 -a $REDIS_PASSWORD
```

**Data Distribution:**
- Keys automatically sharded based on CRC16(key) % 16384
- Client follows redirects automatically with `-c` flag
- Example: `SET user:1000 "data"` â†’ hashed â†’ routed to correct node

**Why Cluster vs Single Node?**
- âœ… **High Availability:** Continues if one node fails
- âœ… **Horizontal Scaling:** Distribute data across nodes
- âœ… **Performance:** Parallel read/write operations
- âœ… **Production Parity:** Dev environment matches production

**Optional TLS:**
- Enable: Set `REDIS_ENABLE_TLS=true` in `.env`
- Dual ports: 6379 (non-TLS), 6380 (TLS)

---

### RabbitMQ

**Purpose:** Message queue for asynchronous communication between services.

**Configuration:**
- **Image:** `rabbitmq:3-management-alpine`
- **Ports:**
  - 5672 (AMQP protocol)
  - 15672 (Management UI)
- **Static IP:** 172.20.0.14
- **Credentials:** Auto-fetched from Vault at `secret/rabbitmq`
- **Virtual Host:** `dev_vhost`
- **Plugins:** Management UI enabled

**Access:**
```bash
# Management UI
open http://localhost:15672
# Username: dev_admin
# Password: (from Vault)

# AMQP connection string
amqp://dev_admin:password@localhost:5672/dev_vhost
```

**Common Operations:**
```bash
# List queues
docker exec dev-rabbitmq rabbitmqctl list_queues

# List exchanges
docker exec dev-rabbitmq rabbitmqctl list_exchanges

# List connections
docker exec dev-rabbitmq rabbitmqctl list_connections

# View logs
./manage-devstack.sh logs rabbitmq
```

**Use Cases:**
- Task queues (background jobs)
- Event-driven architecture
- Microservice communication
- Decoupling services

**Optional TLS:**
- Enable: Set `RABBITMQ_ENABLE_TLS=true` in `.env`
- AMQPS port: 5671

---

### MongoDB

**Purpose:** NoSQL document database for unstructured data.

**Configuration:**
- **Image:** `mongo:7`
- **Port:** 27017
- **Static IP:** 172.20.0.15
- **Credentials:** Auto-fetched from Vault at `secret/mongodb`
- **Authentication:** SCRAM-SHA-256
- **Storage Engine:** WiredTiger
- **Default Database:** `dev_database`

**Connection:**
```bash
# Using mongosh (MongoDB Shell)
mongosh --host localhost --port 27017 \
  --username dev_admin \
  --password $(./manage-devstack.sh vault-show-password mongodb) \
  --authenticationDatabase admin

# Connection string
mongodb://dev_admin:password@localhost:27017/dev_database?authSource=admin
```

**Common Operations:**
```bash
# Shell access
docker exec -it dev-mongodb mongosh -u dev_admin -p

# View databases
docker exec dev-mongodb mongosh --eval "show dbs"

# View collections
docker exec dev-mongodb mongosh dev_database --eval "show collections"
```

**Optional TLS:**
- Enable: Set `MONGODB_ENABLE_TLS=true` in `.env`
- Certificates: Auto-generated by Vault PKI

---

### Forgejo (Git Server)

**Purpose:** Self-hosted Git server (Gitea fork) for private repositories.

**Configuration:**
- **Image:** `codeberg.org/forgejo/forgejo:1.21`
- **Ports:**
  - 3000 (HTTP/HTTPS web interface)
  - 2222 (SSH - avoids conflict with macOS SSH on 22)
- **Static IP:** 172.20.0.20
- **Database:** PostgreSQL (uses existing PostgreSQL service)
- **Storage:** Docker volume (`forgejo_data`)

**First-Time Setup:**
1. Open http://localhost:3000
2. Complete installation wizard:
   - **Database Type:** PostgreSQL
   - **Host:** `postgres:5432`
   - **Database:** `forgejo`
   - **Username/Password:** Same as PostgreSQL (from Vault)
3. Create admin account
4. Start creating repositories!

**Git Operations:**
```bash
# Clone via HTTP
git clone http://localhost:3000/username/repo.git

# Clone via SSH (port 2222)
git clone ssh://git@localhost:2222/username/repo.git

# Configure SSH for easier access
cat >> ~/.ssh/config <<EOF
Host forgejo
  HostName localhost
  Port 2222
  User git
  IdentityFile ~/.ssh/id_rsa
EOF

# Then clone with short alias
git clone forgejo:username/repo.git
```

**Access from Network:**
- Set `FORGEJO_DOMAIN` to Colima IP in `.env`
- Example: http://192.168.106.2:3000
- Useful for accessing from UTM VMs or other machines

**Features:**
- Git repository hosting
- Pull requests and code review
- Issue tracking
- Wiki pages
- CI/CD (Actions)
- Package registry
- LFS (Large File Storage)

---

## Observability Stack

### Prometheus

**Purpose:** Metrics collection and time-series database.

**Configuration:**
- **Image:** `prom/prometheus:v2.48.0`
- **Port:** 9090
- **Static IP:** 172.20.0.101
- **Storage:** Docker volume (`prometheus_data`)
- **Retention:** 15 days

**Access:**
```bash
# Web UI
open http://localhost:9090

# Query metrics
curl http://localhost:9090/api/v1/query?query=up

# Health check
curl http://localhost:9090/-/healthy
```

**Monitored Services:**
- PostgreSQL (via postgres-exporter)
- Redis (via redis-exporters)
- RabbitMQ (built-in metrics)
- All reference applications
- Vault
- Container metrics (via cAdvisor)

**Example Queries:**
```promql
# CPU usage by container
rate(container_cpu_usage_seconds_total[5m])

# Redis operations per second
rate(redis_commands_processed_total[1m])

# HTTP request rate
rate(http_requests_total[5m])
```

---

### Grafana

**Purpose:** Visualization and dashboards for metrics and logs.

**Configuration:**
- **Image:** `grafana/grafana:10.2.2`
- **Port:** 3001
- **Static IP:** 172.20.0.102
- **Default Credentials:** admin/admin (change on first login)
- **Data Sources:** Prometheus, Loki (pre-configured)

**Access:**
```bash
open http://localhost:3001
# Username: admin
# Password: admin (change on first login)
```

**Pre-configured Dashboards:**
- Docker Container Metrics
- PostgreSQL Performance
- Redis Cluster Overview
- RabbitMQ Monitoring
- Application Request Rates

**Features:**
- Real-time metrics visualization
- Log exploration (via Loki)
- Alerting
- Dashboard sharing
- Custom panels and queries

---

### Loki

**Purpose:** Log aggregation system (like Prometheus, but for logs).

**Configuration:**
- **Image:** `grafana/loki:2.9.3`
- **Port:** 3100
- **Static IP:** 172.20.0.103
- **Storage:** Docker volume (`loki_data`)

**Log Collection:**
- Logs collected by Vector
- Shipped to Loki for storage
- Queried via Grafana or LogCLI

**Access:**
```bash
# Query logs via API
curl http://localhost:3100/loki/api/v1/query?query='{service="postgres"}'

# View in Grafana
open http://localhost:3001/explore
# Select Loki data source
```

**LogQL Examples:**
```logql
# All PostgreSQL logs
{service="postgres"}

# Error logs from all services
{level="error"}

# Redis logs in last 5 minutes
{service="redis"} |= "error" [5m]
```

---

### Vector

**Purpose:** Unified observability data pipeline (logs + metrics).

**Configuration:**
- **Image:** `timberio/vector:latest`
- **Port:** 8686 (health/metrics)
- **Static IP:** 172.20.0.104

**What Vector Does:**
- Collects logs from all Docker containers
- Scrapes metrics from databases (Postgres, MySQL, MongoDB)
- Ships logs to Loki
- Exposes metrics to Prometheus
- Replaces multiple single-purpose exporters

**Benefits:**
- Single data pipeline (reduces container count)
- Consistent log formatting
- Efficient resource usage
- Centralized configuration

---

### cAdvisor

**Purpose:** Container resource monitoring (CPU, memory, network, disk).

**Configuration:**
- **Image:** `gcr.io/cadvisor/cadvisor:latest`
- **Port:** 8080
- **Metrics Exposed:** Port 8080 (scraped by Prometheus)

**Access:**
```bash
# Web UI
open http://localhost:8080

# View container metrics
curl http://localhost:8080/metrics
```

**Metrics Provided:**
- CPU usage per container
- Memory usage and limits
- Network I/O
- Disk I/O
- Container lifecycle events

---

## Reference Applications

All reference applications demonstrate identical core functionality using different languages/frameworks.

### Common Features

**All applications provide:**
- âœ… Vault integration (credential retrieval)
- âœ… PostgreSQL CRUD operations
- âœ… Redis Cluster operations
- âœ… RabbitMQ messaging
- âœ… MongoDB operations
- âœ… Health checks for all dependencies
- âœ… Dual HTTP/HTTPS support
- âœ… Prometheus metrics
- âœ… OpenAPI documentation

**Endpoints:**
- `GET /health` - Overall health status
- `GET /health/postgres` - PostgreSQL connection
- `GET /health/redis` - Redis cluster status
- `GET /health/rabbitmq` - RabbitMQ connection
- `GET /health/mongodb` - MongoDB connection
- `GET /metrics` - Prometheus metrics
- `GET /docs` - API documentation

---

### FastAPI Code-First

**Implementation approach:** Code drives documentation (typical rapid development).

**Configuration:**
- **Language:** Python 3.11
- **Framework:** FastAPI
- **Ports:** 8000 (HTTP), 8443 (HTTPS)
- **Static IP:** 172.20.0.100

**Key Features:**
- Most comprehensive implementation (reference)
- Extensive test coverage (254 unit tests)
- Advanced patterns: caching, rate limiting, circuit breakers
- Detailed logging and error handling

**Access:**
```bash
# HTTP
curl http://localhost:8000/health

# HTTPS (self-signed cert)
curl -k https://localhost:8443/health

# OpenAPI docs
open http://localhost:8000/docs
```

---

### FastAPI API-First

**Implementation approach:** OpenAPI specification drives code (contract-first).

**Configuration:**
- **Language:** Python 3.11
- **Framework:** FastAPI
- **Ports:** 8001 (HTTP), 8444 (HTTPS)
- **Static IP:** 172.20.0.101

**Key Difference:**
- Starts with OpenAPI spec (`api/openapi.yaml`)
- Code implements the contract
- Ensures API consistency
- Better for team collaboration

---

### Go/Gin API

**Implementation approach:** Production-ready compiled binary with goroutines.

**Configuration:**
- **Language:** Go 1.23+
- **Framework:** Gin
- **Ports:** 8002 (HTTP), 8445 (HTTPS)
- **Static IP:** 172.20.0.102

**Key Features:**
- Fast startup time
- Low memory footprint
- Native concurrency (goroutines)
- Single binary deployment

---

### Node.js/Express API

**Implementation approach:** Event-driven with async/await patterns.

**Configuration:**
- **Language:** Node.js 18+
- **Framework:** Express
- **Ports:** 8003 (HTTP), 8446 (HTTPS)
- **Static IP:** 172.20.0.103

**Key Features:**
- Non-blocking I/O
- NPM ecosystem
- JavaScript/TypeScript familiarity
- Rapid prototyping

---

### Rust/Actix-web API

**Implementation approach:** Memory-safe, high-performance async API.

**Configuration:**
- **Language:** Rust 1.70+
- **Framework:** Actix-web
- **Ports:** 8004 (HTTP), 8447 (HTTPS)
- **Static IP:** 172.20.0.104

**Key Features:**
- Memory safety without garbage collection
- Zero-cost abstractions
- Excellent performance
- Compile-time guarantees

---

### TypeScript API-First

**Implementation approach:** OpenAPI-driven with TypeScript type safety.

**Configuration:**
- **Language:** TypeScript/Node.js
- **Framework:** Express
- **Ports:** 8005 (HTTP), 8448 (HTTPS)
- **Static IP:** 172.20.0.105

**Key Features:**
- Type safety
- OpenAPI contract enforcement
- Modern JavaScript features
- IDE autocomplete support

---

## Service Dependencies

**Dependency Graph:**
```
Vault (first)
  â”œâ”€â”€ PostgreSQL â†’ PgBouncer
  â”œâ”€â”€ MySQL
  â”œâ”€â”€ Redis Cluster (3 nodes)
  â”œâ”€â”€ RabbitMQ
  â”œâ”€â”€ MongoDB
  â””â”€â”€ Forgejo
      â””â”€â”€ Uses PostgreSQL

Observability (parallel)
  â”œâ”€â”€ Prometheus
  â”œâ”€â”€ Grafana â†’ Prometheus + Loki
  â”œâ”€â”€ Loki
  â”œâ”€â”€ Vector â†’ Loki + Prometheus
  â””â”€â”€ cAdvisor â†’ Prometheus

Reference Apps (last)
  â”œâ”€â”€ FastAPI Code-First
  â”œâ”€â”€ FastAPI API-First
  â”œâ”€â”€ Go/Gin
  â”œâ”€â”€ Node.js/Express
  â”œâ”€â”€ Rust/Actix-web
  â””â”€â”€ TypeScript API-First
```

**Startup Order:**
1. Vault starts and auto-unseals
2. All infrastructure services start (fetch credentials from Vault)
3. Observability stack starts
4. Reference applications start

---

## Resource Allocation

**Total Memory Usage:** ~4-5GB (all services running)

**Per Service (approximate):**
- Vault: 128MB
- PostgreSQL: 512MB
- Redis Cluster (3 nodes): 768MB (256MB each)
- RabbitMQ: 256MB
- MongoDB: 512MB
- Prometheus: 512MB
- Grafana: 256MB
- Reference APIs: ~200MB each
- Others: ~100-200MB each

**Recommended Colima VM:**
- **CPU:** 4-6 cores
- **Memory:** 8-12GB
- **Disk:** 60GB+

**Adjust with:**
```bash
colima stop
colima start --cpu 6 --memory 12 --disk 100
```

---

## Port Reference

**Quick port lookup:**

| Service | HTTP | HTTPS/TLS | Other |
|---------|------|-----------|-------|
| Vault | 8200 | - | - |
| PostgreSQL | - | - | 5432 |
| PgBouncer | - | - | 6432 |
| MySQL | - | - | 3306 |
| Redis Node 1 | - | - | 6379, 16379 |
| Redis Node 2 | - | - | 6380, 16380 |
| Redis Node 3 | - | - | 6381, 16381 |
| RabbitMQ | 15672 (UI) | - | 5672 (AMQP) |
| MongoDB | - | - | 27017 |
| Forgejo | 3000 | - | 2222 (SSH) |
| Prometheus | 9090 | - | - |
| Grafana | 3001 | - | - |
| Loki | 3100 | - | - |
| cAdvisor | 8080 | - | - |
| FastAPI Code-First | 8000 | 8443 | - |
| FastAPI API-First | 8001 | 8444 | - |
| Go API | 8002 | 8445 | - |
| Node.js API | 8003 | 8446 | - |
| Rust API | 8004 | 8447 | - |
| TypeScript API | 8005 | 8448 | - |

---

## Next Steps

- **[Quick Start Guide](Quick-Start-Guide)** - Get started in 5 minutes
- **[Installation](Installation)** - Detailed installation instructions
- **[First-Time Setup](First-Time-Setup)** - Vault initialization and bootstrap
- **[Management Commands](Management-Commands)** - CLI reference
- **[Common Issues](Common-Issues)** - Troubleshooting
- **[Reference Applications](Reference-Applications)** - Multi-language API guide
- **[Architecture Overview](Architecture-Overview)** - System architecture

---

**Questions?** See [FAQ](FAQ) or [open an issue](https://github.com/NormB/devstack-core/issues).
