# Installation Guide

Complete step-by-step guide to installing DevStack Core on macOS (Apple Silicon).

## Table of Contents

- [Prerequisites](#prerequisites)
- [Installation Steps](#installation-steps)
- [Verification](#verification)
- [Troubleshooting](#troubleshooting)
- [Next Steps](#next-steps)

## Prerequisites

### System Requirements

| Requirement | Minimum | Recommended |
|-------------|---------|-------------|
| **macOS Version** | 12.0 (Monterey) | 14.0+ (Sonoma) |
| **Processor** | Apple Silicon (M Series Processors) | Later M Series Models |
| **RAM** | 16GB | 32GB |
| **Free Disk Space** | 60GB | 100GB |

### Pre-Installation Checks

**Check macOS Version:**
```bash
sw_vers

# Expected output:
# ProductName:    macOS
# ProductVersion: 14.x.x
```

**Check Available RAM:**
```bash
sysctl hw.memsize | awk '{print $2/1073741824" GB"}'

# Expected: 16 GB or higher
```

**Check Free Disk Space:**
```bash
df -h ~

# Ensure "Avail" shows 60GB or more
```

**Check for Docker Desktop Conflicts:**
```bash
pgrep -f "Docker Desktop"

# If this shows PIDs, Docker Desktop is running
# Quit Docker Desktop: Menu bar ‚Üí Docker icon ‚Üí Quit
```

**Why:** Colima and Docker Desktop can conflict. Use one or the other, not both simultaneously.

## Installation Steps

### Step 1: Install Homebrew

**Check if already installed:**
```bash
which brew
```

**If not found, install Homebrew:**
```bash
/bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
```

**Follow on-screen instructions to add Homebrew to PATH:**
```bash
# Apple Silicon (M Series Processors)
echo 'eval "$(/opt/homebrew/bin/brew shellenv)"' >> ~/.zprofile
eval "$(/opt/homebrew/bin/brew shellenv)"
```

**Time:** 5-10 minutes

### Step 2: Install Required Software

**Install Colima, Docker, and Docker Compose:**
```bash
brew install colima docker docker-compose
```

**Expected output:**
```
üç∫  colima was successfully installed!
üç∫  docker was successfully installed!
üç∫  docker-compose was successfully installed!
```

**Time:** 5-15 minutes (depends on internet speed)

**Verify installations:**
```bash
colima version
# Expected: colima version 0.6.x or higher

docker --version
# Expected: Docker version 24.x.x or higher

docker-compose --version
# Expected: Docker Compose version 2.x.x or higher
```

**Troubleshooting:**
- If "command not found", restart your terminal
- Run `brew doctor` to diagnose Homebrew issues

### Step 3: Clone Repository

**Navigate to home directory:**
```bash
cd ~
pwd
# Expected: /Users/yourusername
```

**Clone the repository:**
```bash
git clone https://github.com/NormB/devstack-core.git ~/devstack-core
```

**Expected output:**
```
Cloning into '/Users/yourusername/devstack-core'...
remote: Enumerating objects: ...
Receiving objects: 100% (...), done.
```

**If git not found:**
```bash
brew install git
```

**Navigate to project:**
```bash
cd ~/devstack-core
ls -la
# Should see: .env.example, docker-compose.yml, manage-devstack.sh, etc.
```

### Step 4: Configure Environment

**Create environment file:**
```bash
cp .env.example .env
```

**Make management script executable:**
```bash
chmod +x manage-devstack.sh
```

**Verify:**
```bash
ls -l manage-devstack.sh
# Should show: -rwxr-xr-x (note the 'x' for executable)
```

**Optional - Review configuration:**
```bash
# View environment settings
cat .env | head -30

# Note: Password fields are empty - they'll be generated by Vault
```

### Step 5: Start Services

**Start Colima and all services:**
```bash
./manage-devstack.sh start
```

**Expected output:**
```
============================================
  DevStack Core - Management Script
============================================

[‚úì] Checking environment file...
[‚úì] Environment file found: .env

[*] Starting Colima...
INFO[0000] starting colima
INFO[0001] creating and starting colima VM...
INFO[0155] done

[‚úì] Colima started successfully
    Profile: default
    Colima IP: 192.168.106.2

[*] Starting Docker services...
[+] Running 13/13
 ‚úî Container dev-vault          Started
 ‚úî Container dev-postgres       Started
 ‚úî Container dev-mysql          Started
 ‚úî Container dev-mongodb        Started
 ‚úî Container dev-redis-1        Started
 ‚úî Container dev-redis-2        Started
 ‚úî Container dev-redis-3        Started
 ‚úî Container dev-rabbitmq       Started
 ‚úî Container dev-forgejo        Started
 ‚úî Container dev-prometheus     Started
 ‚úî Container dev-grafana        Started
 ‚úî Container dev-loki           Started
 ‚úî Container dev-reference-api  Started

[‚úì] All services started successfully
```

**Time:** 2-3 minutes on first run

**What happens:**
1. Colima VM starts (Linux VM on macOS)
2. Docker Engine initializes
3. All services start in Docker containers
4. Vault auto-initializes and auto-unseals
5. Health checks verify services are ready

**Common issues:**
- If Colima start fails: `colima delete` then try again
- If services won't start: Check [Common Issues](Common-Issues)

## Verification

### Check Service Status

```bash
./manage-devstack.sh status
```

**Expected output:**
```
NAME              STATE     STATUS    CPU %    MEM USAGE
dev-vault         running   healthy   0.12%    45.5MB
dev-postgres      running   healthy   0.05%    32.1MB
dev-mysql         running   healthy   0.03%    28.3MB
dev-mongodb       running   healthy   0.08%    52.1MB
dev-redis-1       running   healthy   0.08%    12.3MB
dev-redis-2       running   healthy   0.07%    11.8MB
dev-redis-3       running   healthy   0.07%    12.1MB
dev-rabbitmq      running   healthy   0.15%    87.2MB
dev-forgejo       running   healthy   0.10%    65.4MB
dev-prometheus    running   healthy   0.12%    78.3MB
dev-grafana       running   healthy   0.08%    45.1MB
dev-loki          running   healthy   0.05%    32.8MB
dev-reference-api running   healthy   0.10%    55.2MB
```

**All services should show:**
- STATE: `running`
- STATUS: `healthy` (may show `starting` for 30-60 seconds after startup)

### Run Health Checks

```bash
./manage-devstack.sh health
```

**Expected output:**
```
‚úì Vault: healthy
‚úì PostgreSQL: healthy
‚úì MySQL: healthy
‚úì MongoDB: healthy
‚úì Redis Cluster: healthy (3/3 nodes)
‚úì RabbitMQ: healthy
‚úì Forgejo: healthy
‚úì Reference API: healthy
```

### Test Service Access

**Test Vault:**
```bash
curl http://localhost:8200/v1/sys/health
# Should return JSON with "initialized": true, "sealed": false
```

**Test PostgreSQL:**
```bash
docker exec dev-postgres pg_isready
# Should return: accepting connections
```

**Test Redis:**
```bash
docker exec dev-redis-1 redis-cli ping
# Should return: PONG
```

**Test API:**
```bash
curl http://localhost:8000/health/
# Should return: {"status": "healthy"}
```

## Troubleshooting

### Colima Won't Start

**Error:** `colima start` hangs or fails

**Solution:**
```bash
# Complete reset
colima delete
./manage-devstack.sh start
```

### Services Won't Start

**Error:** Services stuck in "starting" state

**Solution:**
```bash
# Check Vault status (all services depend on Vault)
./manage-devstack.sh vault-status

# If Vault sealed, restart it
docker compose restart vault
sleep 30

# Restart all services
./manage-devstack.sh restart
```

### Port Conflicts

**Error:** `bind: address already in use`

**Solution:**
```bash
# Find process using port (example: 5432)
lsof -i :5432

# Kill the process
kill <PID>

# Or change port in .env
echo "POSTGRES_HOST_PORT=5433" >> .env
docker compose up -d postgres
```

### Insufficient Resources

**Error:** Services crash with OOM (out of memory)

**Solution:**
```bash
# Stop Colima
colima stop

# Start with more resources (edit manage-devstack.sh or):
colima start --cpu 6 --memory 12 --disk 100 --network-address
```

### Docker Context Issues

**Error:** `docker ps` shows "Cannot connect to Docker daemon"

**Solution:**
```bash
# Set Docker context to Colima
docker context use colima

# Verify
docker context ls
# Should show 'colima' with asterisk (*)
```

## Next Steps

Now that installation is complete, proceed to:

1. **[First Time Setup](First-Time-Setup)** - Initialize Vault and configure services
2. **[Quick Start Guide](Quick-Start-Guide)** - Learn basic operations
3. **[Management Commands](Management-Commands)** - Explore available commands

### What You've Accomplished

‚úÖ Installed Colima (lightweight Docker runtime)
‚úÖ Installed Docker and Docker Compose
‚úÖ Cloned DevStack Core repository
‚úÖ Configured environment
‚úÖ Started all services
‚úÖ Verified everything is running

### Next: First Time Setup

The services are running, but you need to:
1. **Initialize Vault** - Set up secrets management
2. **Bootstrap Vault** - Generate credentials and certificates
3. **Access services** - Connect to databases and UIs

See [First Time Setup](First-Time-Setup) for the next steps.

## Additional Resources

- **[Common Issues](Common-Issues)** - Troubleshooting guide
- **[Architecture Overview](Architecture-Overview)** - How everything works
- **[Service Configuration](Service-Configuration)** - Configure individual services
- **Full Documentation** - [docs/INSTALLATION.md](https://github.com/NormB/devstack-core/blob/main/docs/INSTALLATION.md)

## Getting Help

If you encounter issues not covered here:

1. Check [Common Issues](Common-Issues)
2. Search [GitHub Issues](https://github.com/NormB/devstack-core/issues)
3. Open a new issue with:
   - macOS version (`sw_vers`)
   - Colima version (`colima version`)
   - Docker version (`docker version`)
   - Error messages and logs

---

**Estimated Total Time:** 20-30 minutes
**Next:** [First Time Setup](First-Time-Setup)
