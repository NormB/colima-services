# Redis Cluster Configuration
# Optimized for local development in Docker
# 3-node cluster with all masters (no replicas)

# ===========================================================================
# Network Settings
# ===========================================================================

# Bind to all interfaces (required for cluster mode)
bind 0.0.0.0

# ===========================================================================
# Cluster Settings
# ===========================================================================

# Enable cluster mode
cluster-enabled yes

# Cluster configuration file (auto-generated)
cluster-config-file nodes.conf

# Node timeout in milliseconds
cluster-node-timeout 5000

# Allow cluster to operate even if some slots are not covered
# Useful for development
cluster-require-full-coverage no

# Accept connections from any IP (password-protected via command line)
protected-mode yes

# Standard Redis port
port 6379

# TCP listen() backlog
tcp-backlog 511

# Close connection after client idle for N seconds (0 to disable)
timeout 0

# TCP keepalive
tcp-keepalive 300

# ===========================================================================
# General Settings
# ===========================================================================

# Run in foreground (Docker handles daemonization)
daemonize no

# Don't create a pidfile
pidfile /var/run/redis.pid

# Log level: debug, verbose, notice, warning
loglevel notice

# Number of databases
databases 16

# ===========================================================================
# Snapshotting (RDB Persistence)
# ===========================================================================

# Save the DB to disk:
# save <seconds> <changes>
# Will save if both conditions are met
# After 900 sec (15 min) if at least 1 key changed
save 900 1
# After 300 sec (5 min) if at least 10 keys changed
save 300 10
# After 60 sec if at least 10000 keys changed
save 60 10000

# Compress RDB files
rdbcompression yes

# Checksum RDB files
rdbchecksum yes

# RDB filename
dbfilename dump.rdb

# Working directory (volume mount in Docker)
dir /data

# ===========================================================================
# Replication
# ===========================================================================

# Disable replication (single instance for dev)
# replicaof <masterip> <masterport>

# ===========================================================================
# Security
# ===========================================================================

# Password is set via command line in docker-compose.yml
# requirepass is set with --requirepass flag

# Disable dangerous commands in production
# rename-command FLUSHDB ""
# rename-command FLUSHALL ""
# rename-command CONFIG ""

# ===========================================================================
# Memory Management
# ===========================================================================

# Maximum memory is set via command line in docker-compose.yml
# maxmemory is set with --maxmemory flag
# maxmemory-policy is set with --maxmemory-policy flag

# ===========================================================================
# Append Only File (AOF Persistence)
# ===========================================================================

# Enable AOF for cluster mode (overridden by command line)
appendonly yes

# AOF filename
appendfilename "appendonly.aof"

# AOF sync policy: always, everysec, no
appendfsync everysec

# Don't use fsync while rewriting AOF
no-appendfsync-on-rewrite no

# ===========================================================================
# Lua Scripting
# ===========================================================================

# Max execution time for Lua scripts in milliseconds
lua-time-limit 5000

# ===========================================================================
# Slow Log
# ===========================================================================

# Log queries slower than N microseconds
slowlog-log-slower-than 10000

# Keep last N slow queries
slowlog-max-len 128

# ===========================================================================
# Event Notification
# ===========================================================================

# Keyspace notifications (disabled by default for performance)
notify-keyspace-events ""

# ===========================================================================
# Advanced Config
# ===========================================================================

# Hash type settings
hash-max-listpack-entries 512
hash-max-listpack-value 64

# List settings
list-max-listpack-size -2
list-compress-depth 0

# Set settings
set-max-intset-entries 512

# Sorted set settings
zset-max-listpack-entries 128
zset-max-listpack-value 64

# HyperLogLog settings
hll-sparse-max-bytes 3000

# Streams settings
stream-node-max-bytes 4096
stream-node-max-entries 100

# Active rehashing
activerehashing yes

# Client output buffer limits
client-output-buffer-limit normal 0 0 0
client-output-buffer-limit replica 256mb 64mb 60
client-output-buffer-limit pubsub 32mb 8mb 60

# Frequency of rehashing (1-100, higher = more CPU, lower = more memory)
hz 10

# Enable active defragmentation (Redis 4.0+)
activedefrag no
